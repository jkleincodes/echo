generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  username      String    @unique
  email         String?   @unique
  emailVerified Boolean   @default(false)
  displayName   String
  passwordHash  String
  avatarUrl     String?
  status        String    @default("offline")
  bio           String?
  customStatus  String?
  bannerColor   String?
  bannerUrl     String?
  pronouns      String?
  totpSecret    String?
  totpEnabledAt DateTime?
  recoveryCodes String?
  createdAt     DateTime  @default(now())

  ownedServers     Server[]     @relation("ServerOwner")
  members          Member[]
  messages         Message[]
  reactions        Reaction[]
  mentions         Mention[]
  pinnedMessages   Message[]    @relation("PinnedBy")
  sentFriendships  Friendship[] @relation("FriendshipSender")
  recvFriendships  Friendship[] @relation("FriendshipReceiver")
  dmParticipants   DMParticipant[]
  dmMessages       DMMessage[]
  channelReadStates ChannelReadState[]
  dmReadStates     DMChannelReadState[]
  invitesCreated   Invite[]
  passwordResetTokens  PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  threads          Thread[]
  threadParticipants ThreadParticipant[]
  threadReadStates ThreadReadState[]
  notificationPreferences NotificationPreference[]
  channelNotificationOverrides ChannelNotificationOverride[]
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailVerificationToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Server {
  id           String    @id @default(cuid())
  name         String
  iconUrl      String?
  description  String?
  ownerId      String
  afkChannelId String?
  afkTimeout   Int       @default(300)
  createdAt    DateTime  @default(now())

  owner      User       @relation("ServerOwner", fields: [ownerId], references: [id])
  afkChannel Channel?   @relation("AfkChannel", fields: [afkChannelId], references: [id], onDelete: SetNull)
  members    Member[]
  channels   Channel[]
  categories ChannelCategory[]
  invites    Invite[]
  roles      Role[]
  bans       ServerBan[]
  soundboardSounds SoundboardSound[]
  notificationPreferences NotificationPreference[]
  webhooks   Webhook[]
}

model Member {
  id       String @id @default(cuid())
  role     String @default("member")
  userId   String
  serverId String

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  server      Server       @relation(fields: [serverId], references: [id], onDelete: Cascade)
  memberRoles MemberRole[]

  @@unique([userId, serverId])
}

model Channel {
  id         String  @id @default(cuid())
  name       String
  type       String  @default("text")
  topic      String?
  position   Int     @default(0)
  serverId   String
  categoryId String?

  server     Server           @relation(fields: [serverId], references: [id], onDelete: Cascade)
  category   ChannelCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  messages   Message[]
  readStates ChannelReadState[]
  permissionOverrides ChannelPermissionOverride[]
  afkForServers Server[]       @relation("AfkChannel")
  threads    Thread[]
  notificationOverrides ChannelNotificationOverride[]
  webhooks   Webhook[]
}

model ChannelCategory {
  id       String @id @default(cuid())
  name     String
  position Int    @default(0)
  serverId String

  server   Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  channels Channel[]
}

model Message {
  id         String    @id @default(cuid())
  content    String
  type       String    @default("default")
  channelId  String
  authorId   String
  replyToId  String?
  threadId   String?
  webhookId  String?
  pinnedAt   DateTime?
  pinnedById String?
  createdAt  DateTime  @default(now())
  editedAt   DateTime?

  channel       Channel      @relation(fields: [channelId], references: [id], onDelete: Cascade)
  author        User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  pinnedBy      User?        @relation("PinnedBy", fields: [pinnedById], references: [id], onDelete: SetNull)
  replyTo       Message?     @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies       Message[]    @relation("MessageReplies")
  thread        Thread?      @relation("ThreadMessages", fields: [threadId], references: [id], onDelete: SetNull)
  startedThread Thread?      @relation("StarterMessage")
  webhook       Webhook?     @relation(fields: [webhookId], references: [id], onDelete: SetNull)
  attachments   Attachment[]
  reactions     Reaction[]
  embeds        Embed[]
  mentions      Mention[]

  @@index([channelId, createdAt])
  @@index([threadId, createdAt])
}

model Attachment {
  id        String  @id @default(cuid())
  filename  String
  storedAs  String
  mimeType  String
  size      Int
  messageId String

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model Reaction {
  id        String @id @default(cuid())
  emoji     String
  userId    String
  messageId String

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId, emoji])
}

model Embed {
  id          String  @id @default(cuid())
  url         String
  title       String?
  description String?
  imageUrl    String?
  siteName    String?
  favicon     String?
  messageId   String

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model Mention {
  id        String @id @default(cuid())
  userId    String
  messageId String

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId])
}

model Invite {
  id        String    @id @default(cuid())
  code      String    @unique
  serverId  String
  creatorId String
  maxUses   Int?
  uses      Int       @default(0)
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  server  Server @relation(fields: [serverId], references: [id], onDelete: Cascade)
  creator User   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model Friendship {
  id         String @id @default(cuid())
  status     String @default("pending")
  senderId   String
  receiverId String
  createdAt  DateTime @default(now())

  sender   User @relation("FriendshipSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("FriendshipReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
}

model DMChannel {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  participants DMParticipant[]
  messages     DMMessage[]
  readStates   DMChannelReadState[]
}

model DMParticipant {
  id        String @id @default(cuid())
  userId    String
  channelId String

  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel DMChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
}

model DMMessage {
  id        String    @id @default(cuid())
  content   String
  channelId String
  authorId  String
  createdAt DateTime  @default(now())
  editedAt  DateTime?

  channel DMChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  author  User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([channelId, createdAt])
}

model ChannelReadState {
  id                String   @id @default(cuid())
  userId            String
  channelId         String
  lastReadMessageId String?
  mentionCount      Int      @default(0)
  updatedAt         DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
}

model DMChannelReadState {
  id                String   @id @default(cuid())
  userId            String
  channelId         String
  lastReadMessageId String?
  updatedAt         DateTime @updatedAt

  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel DMChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
}

model Role {
  id          String @id @default(cuid())
  name        String
  color       String?
  position    Int     @default(0)
  permissions String  @default("0")
  serverId    String

  server      Server       @relation(fields: [serverId], references: [id], onDelete: Cascade)
  memberRoles MemberRole[]
  permissionOverrides ChannelPermissionOverride[]
}

model MemberRole {
  id       String @id @default(cuid())
  memberId String
  roleId   String

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([memberId, roleId])
}

model ChannelPermissionOverride {
  id        String  @id @default(cuid())
  channelId String
  roleId    String?
  userId    String?
  allow     String  @default("0")
  deny      String  @default("0")

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  role    Role?   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([channelId, roleId, userId])
}

model ServerBan {
  id         String   @id @default(cuid())
  userId     String
  serverId   String
  reason     String?
  bannedById String
  createdAt  DateTime @default(now())

  server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@unique([userId, serverId])
}

model SoundboardSound {
  id         String   @id @default(cuid())
  name       String
  emoji      String?
  filename   String
  serverId   String
  uploaderId String
  createdAt  DateTime @default(now())

  server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@index([serverId])
}

model Thread {
  id               String   @id @default(cuid())
  name             String
  channelId        String
  starterMessageId String   @unique
  creatorId        String
  archived         Boolean  @default(false)
  lastActivityAt   DateTime @default(now())
  messageCount     Int      @default(0)
  createdAt        DateTime @default(now())

  channel        Channel             @relation(fields: [channelId], references: [id], onDelete: Cascade)
  starterMessage Message             @relation("StarterMessage", fields: [starterMessageId], references: [id], onDelete: Cascade)
  creator        User                @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  messages       Message[]           @relation("ThreadMessages")
  participants   ThreadParticipant[]
  readStates     ThreadReadState[]

  @@index([channelId, lastActivityAt])
}

model ThreadParticipant {
  id       String @id @default(cuid())
  threadId String
  userId   String

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
}

model ThreadReadState {
  id                String   @id @default(cuid())
  userId            String
  threadId          String
  lastReadMessageId String?
  mentionCount      Int      @default(0)
  updatedAt         DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([userId, threadId])
}

model NotificationPreference {
  id               String    @id @default(cuid())
  userId           String
  serverId         String
  level            String    @default("everything")
  muted            Boolean   @default(false)
  mutedUntil       DateTime?
  suppressEveryone Boolean   @default(false)
  suppressHere     Boolean   @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@unique([userId, serverId])
}

model ChannelNotificationOverride {
  id         String    @id @default(cuid())
  userId     String
  channelId  String
  level      String    @default("default")
  muted      Boolean   @default(false)
  mutedUntil DateTime?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
}

model Webhook {
  id        String   @id @default(cuid())
  name      String
  avatarUrl String?
  token     String   @unique
  channelId String
  serverId  String
  creatorId String
  createdAt DateTime @default(now())

  channel  Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  server   Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([channelId])
  @@index([serverId])
}
